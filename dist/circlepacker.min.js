!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.CirclePacker=t()}(this,function(){"use strict";function e(e,t){e.postMessage(JSON.stringify(t))}function t(e){return e.data?JSON.parse(e.data):{}}function i(e){return e&&e.id&&e.radius&&e.position&&"number"==typeof e.position.x&&"number"==typeof e.position.y}function r(e){return e&&"number"==typeof e.width&&"number"==typeof e.height}var o=function(e){this.worker=new Worker(URL.createObjectURL(new Blob(['function sendWorkerMessage(e,i){e.postMessage(JSON.stringify(i))}function processWorkerMessage(e){return e.data?JSON.parse(e.data):{}}function receivedMessage(e){var i=processWorkerMessage(e),t=i.type,r=i.message;"bounds"===t&&circleManager.setBounds(r),"target"===t&&setTarget(r),"addcircles"===t&&addCircles(r),"removecircle"===t&&circleManager.removeCircle(r),"update"===t&&update(),"dragstart"===t&&circleManager.dragStart(r.id,r.position),"drag"===t&&circleManager.drag(r.id,r.position),"dragend"===t&&circleManager.dragEnd(r.id),"centeringpasses"===t&&"number"==typeof r&&r>0&&(circleManager.numberOfCenteringPasses=r),"collisionpasses"===t&&"number"==typeof r&&r>0&&(circleManager.numberOfCollisionPasses=r)}function updatePage(e,i){sendWorkerMessage(self,{type:e,message:i})}function addCircles(e){Array.isArray(e)&&e.length&&e.forEach(circleManager.addCircle.bind(circleManager))}function setTarget(e){e&&"number"==typeof e.x&&"number"==typeof e.y&&circleManager.setTarget(new Vector(e))}function update(){circleManager.updatePositions(),sendPositions()}function sendPositions(){var e=circleManager.allCircles.reduce(function(e,i){return e[i.id]={position:i.position,previousPosition:i.previousPosition,radius:i.radius,delta:i.delta},e},{});updatePage("move",e)}var Vector=function(e,i){"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e,this.y=i)};Vector.prototype.cp=function(){return new Vector(this.x,this.y)},Vector.prototype.mul=function(e){return this.x*=e,this.y*=e,this},Vector.prototype.normalize=function(){var e=this.length();return this.x/=e,this.y/=e,this},Vector.prototype.length=function e(){var e=Math.sqrt(this.x*this.x+this.y*this.y);return e<.005&&e>-.005?1e-6:e},Vector.prototype.distance=function(e){var i=this.x-e.x,t=this.y-e.y;return Math.sqrt(i*i+t*t)},Vector.prototype.distanceSquared=function(e){var i=this.x-e.x,t=this.y-e.y;return i*i+t*t};var PackedCircle=function(e,i,t,r){void 0===t&&(t=0),void 0===r&&(r=0),this.id=e,this.targetPosition=new Vector(0,0),this.position=new Vector(t,r),this.previousPosition=new Vector(t,r),this.positionWithOffset=new Vector(t,r),this.previousPositionWithOffset=new Vector(t,r),this.setRadius(i)},prototypeAccessors={delta:{}};PackedCircle.prototype.setPosition=function(e){this.previousPosition=this.position,this.position=e.cp()},PackedCircle.prototype.distanceSquaredFromTargetPosition=function(){var e=this.position.distanceSquared(this.targetPosition);return e<this.radiusSquared},PackedCircle.prototype.setRadius=function(e){this.radius=e,this.radiusSquared=e*e,this.originalRadius=e},prototypeAccessors.delta.get=function(){return new Vector(this.position.x-this.previousPosition.x,this.position.y-this.previousPosition.y)},Object.defineProperties(PackedCircle.prototype,prototypeAccessors);var PackedCircleManager=function(){this.allCircles=[],this.desiredTarget=new Vector(0,0),this.bounds={left:0,top:0,right:0,bottom:0},this.numberOfCenteringPasses=1,this.numberOfCollisionPasses=3};PackedCircleManager.prototype.setBounds=function(e){this.bounds=e},PackedCircleManager.prototype.addCircle=function(e){e instanceof PackedCircle||(e=new PackedCircle(e.id,e.radius,e.position.x,e.position.y)),this.allCircles.push(e),e.targetPosition=this.desiredTarget.cp()},PackedCircleManager.prototype.removeCircle=function(e){for(var i=this,t=this.allCircles.reduce(function(i,t,r){return t.id===e&&i.push(r),i},[]),r=t.length-1;r>=0;r--)i.allCircles.splice(t[r],1)},PackedCircleManager.prototype.updatePositions=function(){for(var e=this.allCircles,i=e.length,t=0;t<i;++t){var r=e[t];r.previousPosition=r.position.cp()}this.desiredTarget&&this.pushAllCirclesTowardTarget(this.desiredTarget),this.handleCollisions()},PackedCircleManager.prototype.pushAllCirclesTowardTarget=function(e){for(var i=new Vector(0,0),t=this.draggedCircle,r=this.allCircles,s=r.length,o=0;o<this.numberOfCenteringPasses;o++)for(var n=.025,a=0;a<s;a++){var c=r[a];c!==t&&(i.x=c.position.x-e.x,i.y=c.position.y-e.y,i.mul(n),c.position.x-=i.x,c.position.y-=i.y)}},PackedCircleManager.prototype.handleCollisions=function(){for(var e=new Vector(0,0),i=this.draggedCircle,t=this.allCircles,r=t.length,s=0;s<this.numberOfCollisionPasses;s++)for(var o=0;o<r;o++)for(var n=t[o],a=o+1;a<r;a++){var c=t[a];if(n!==c){var d=c.position.x-n.position.x,l=c.position.y-n.position.y,p=1.08*(n.radius+c.radius),u=n.position.distanceSquared(c.position);if(u<p*p-.02){e.x=d,e.y=l,e.normalize();var g=.5*(p-Math.sqrt(u));e.mul(g),c!==i&&(n===i&&e.mul(2.2),c.position.x+=e.x,c.position.y+=e.y),n!==i&&(c===i&&e.mul(2.2),n.position.x-=e.x,n.position.y-=e.y)}}}},PackedCircleManager.prototype.setDraggedCircle=function(e){this.draggedCircle&&this.draggedCircle!==e&&(this.draggedCircle.radius=this.draggedCircle.originalRadius),this.draggedCircle=e},PackedCircleManager.prototype.dragStart=function(e){var i=this.allCircles.filter(function(i){return i.id===e})[0];this.setDraggedCircle(i)},PackedCircleManager.prototype.dragEnd=function(e){this.draggedCircle&&this.setDraggedCircle(null)},PackedCircleManager.prototype.drag=function(e,i){this.draggedCircle&&i&&(this.draggedCircle.position.x=i.x,this.draggedCircle.position.y=i.y)},PackedCircleManager.prototype.setTarget=function(e){this.desiredTarget=e},self.addEventListener("message",receivedMessage);var circleManager=new PackedCircleManager;'],{type:"text/javascript"}))),this.worker.addEventListener("message",this.receivedWorkerMessage.bind(this)),this.isContinuousModeActive="boolean"!=typeof e.continuousMode||e.continuousMode,this.onMoveStart=e.onMoveStart||null,this.onMove=e.onMove||null,this.onMoveEnd=e.onMoveEnd||null,e.centeringPasses&&this.setCenteringPasses(e.centeringPasses),e.collisionPasses&&this.setCollisionPasses(e.collisionPasses),this.addCircles(e.circles),this.setBounds(e.bounds),this.setTarget(e.target),this.isLooping=!1,this.areItemsMoving=!0,this.animationFrameId=NaN,this.initialized=!0,this.isContinuousModeActive&&this.startLoop()};return o.prototype.receivedWorkerMessage=function(e){var i=t(e);if("move"===i.type){var r=i.message;this.areItemsMoving=this.hasItemMoved(r)}this.updateListeners(i)},o.prototype.updateWorker=function(t,i){e(this.worker,{type:t,message:i})},o.prototype.updateListeners=function(e){var t=e.type,i=e.message;"movestart"===t&&"function"==typeof this.onMoveStart&&this.onMoveStart(i),"move"===t&&"function"==typeof this.onMove&&this.onMove(i),"moveend"===t&&"function"==typeof this.onMoveEnd&&this.onMoveEnd(i)},o.prototype.addCircles=function(e){if(Array.isArray(e)&&e.length){var t=e.filter(i);t.length&&this.updateWorker("addcircles",t)}this.startLoop()},o.prototype.addCircle=function(e){this.addCircles([e])},o.prototype.removeCircle=function(e){e&&(e.id?this.updateWorker("removecircle",e.id):this.updateWorker("removecircle",e),this.startLoop())},o.prototype.setBounds=function(e){r(e)&&(this.updateWorker("bounds",e),this.startLoop())},o.prototype.setTarget=function(e){this.updateWorker("target",e),this.startLoop()},o.prototype.setCenteringPasses=function(e){this.updateWorker("centeringpasses",e)},o.prototype.setCollisionPasses=function(e){this.updateWorker("collisionpasses",e)},o.prototype.update=function(){this.updateWorker("update")},o.prototype.dragStart=function(e){this.updateWorker("dragstart",{id:e}),this.startLoop()},o.prototype.drag=function(e,t){this.updateWorker("drag",{id:e,position:t}),this.startLoop()},o.prototype.dragEnd=function(e){this.updateWorker("dragend",{id:e}),this.startLoop()},o.prototype.updateLoop=function(){this.update(),this.isLooping&&(this.areItemsMoving?this.animationFrameId=requestAnimationFrame(this.updateLoop.bind(this)):this.stopLoop())},o.prototype.startLoop=function(){!this.isLooping&&this.initialized&&this.isContinuousModeActive&&(this.isLooping=!0,this.isContinuousModeActive&&(this.areItemsMoving=!0),this.updateListeners("movestart"),this.animationFrameId=requestAnimationFrame(this.updateLoop.bind(this)))},o.prototype.stopLoop=function(){this.isLooping&&(this.isLooping=!1,this.updateListeners("moveend"),cancelAnimationFrame(this.animationFrameId))},o.prototype.hasItemMoved=function(e){var t=!1;for(var i in e)Math.abs(e[i].delta.x)>.005&&Math.abs(e[i].delta.y)>.005&&(t=!0);return t},o.prototype.destroy=function(){this.worker&&this.worker.terminate(),this.stopLoop()},o});